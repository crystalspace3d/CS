SubDir TOP plugins cscript ;

if $(PYTHON.AVAILABLE) = "yes"
{
  if $(CMD.SWIG)
  {
    if $(PYTHON.VERSION) >= "2.5"
    {
      if $(CMD.SWIG.VERSION) >= "1.3.31"
      {
        DO_SWIG_PYTHON = "yes" ;
      }
    }
    else
    {
      if $(CMD.SWIG.VERSION) >= "1.3.28"
      {
        DO_SWIG_PYTHON = "yes" ;
      }
    }
  }
  if $(DO_SWIG_PYTHON)
  {
    # global python freeze target
    Help pythonfreeze : "Freeze generated Swig files for all python modules" ;
  }
  ##  PyBindingModule target : module name : glue : LinkWith : ExternalLibs : desc ;
  rule PyBindingModule
  {
    local target = $(1) ;
    local module = $(2) ;
    #--------
    # Swig-generated files for 'target'.
    #--------
    local common = cs_$(module).cpp ;
    local modulepy = [ DoSourceGrist $(module).py ] ;
    MakeLocate $(modulepy) : [ ConcatDirs $(LOCATE.OBJECTS) bindings python cspace ] ;
  
    if ! [ Property build : projgen ]
    {
      common = [ DoSourceGrist $(common) ] ;

      if $(DO_SWIG_PYTHON)
      {
	Swig $(common) $(modulepy) :
	  [ DoSourceGrist $(module).i ] :
	  python :
	  -c++ -shadow -modern :
	  [ ConcatDirs $(TOP) include ]
	  [ ConcatDirs $(BUILDTOP) include ] :
	  [ ConcatDirs $(TOP) include bindings ]
	  [ ConcatDirs $(TOP) include bindings python ] :
	  $(SEARCH_SOURCE) [ ConcatDirs $(TOP) scripts python frozen cspace ] :
	  $(module) :
	  [ on $(modulepy) GetVar LOCATE ] ;
	Depends $(module)clean : $(module)swigclean ;
      }
      else
      {
	SEARCH on $(common) = $(SEARCH_SOURCE) ;
	local frozenpy = $(modulepy:G=frozenmodulepy) ;
	SEARCH on $(frozenpy) = [ ConcatDirs $(TOP) scripts python frozen cspace ] ;
	Copy $(modulepy) : $(frozenpy) ;
	Depends $(modulepy) : $(frozenpy) ;
      }
    }
    Clean $(module)clean : $(modulepy) ;
    Depends bindingsclean : $(module)clean ;
    Depends clean : $(module)clean ;
  
    InstallBindingsData $(modulepy) : [ on $(<) GetVar LOCATE ] : bindings python cspace ;
  
  
    #--------
    # core -- Pure Python module
    #--------
    PythMod $(target) : _$(module) : 
	  $(3) $(common) : 
	  bindings python cspace :
	  crystalspace $(4) : 
	  $(5) : 
	  $(6) ;
    Depends $(target) : $(modulepy) ;
    CFlags $(target) : [ FDefines SWIG_GLOBAL ] $(COMPILER.C++FLAGS.STRICTALIASING.DISABLE) $(COMPILER.C++FLAGS.WARNING.NO_UNINITIALIZED) ;
    Depends bindingsclean : $(target)clean ;
  }
}

if $(CSHARP.AVAILABLE) = "yes"
{
  ##  CSharpBindingModule target : module name : glue : LinkWith : ExternalLibs : desc ;
  rule CSharpBindingModule
  {
    local target = $(1) ;
    local module = $(2) ;
    local modulecs = csh$(module) ;
    if $(module) = iengine
    {
      local modulecs_f = [ DoSourceGrist $(module)mod.cs ] ;
    }
    else
    {
      local modulecs_f = [ DoSourceGrist $(module).cs ] ;
    }
    #----------------------------------
    # Swig generate files for target
    #--------------------------------
    local common = [ DoSourceGrist cs_$(module).cpp ] ;
    local csharpbase = [ ConcatDirs $(LOCATE.OBJECTS) bindings csharp ] ;
    local csharpdir = [ ConcatDirs $(csharpbase) cspacesharp ] ;

    Depends $(common) : $(csharpdir:G=dir) ;
    MkDir $(csharpdir:G=dir) ;

    if ! [ Property build : projgen ]
    {
       Swig $(common) $(modulecs_f) :
	[ DoSourceGrist $(module).i ] :
	csharp :
	-c++ -namespace CrystalSpace -dllimport $(modulecs) -DFILE_FOR_CLASS -DPER_LANGUAGE_OPERATORS :
	[ ConcatDirs $(TOP) include ] 
	[ ConcatDirs $(BUILDTOP) include ] :
	[ ConcatDirs $(TOP) include bindings ]
	[ ConcatDirs $(TOP) include bindings csharp ] :
	:
	:
        $(csharpdir) ;
    }
    
    CleanDir $(modulecs)clean : $(csharpdir) ;
    Clean $(modulecs)clean : $(common) ;
    Depends bindingsclean : $(modulecs)clean ;
    Depends clean : $(modulecs)clean ;
    Depends csharpmodclean : $(modulecs)clean ;

    #-------------------
    # C# module c side
    #-------------------
    CSharpMod $(target) : $(modulecs) :
	    $(3) $(common) :
	    bindings csharp :
            crystalspace $(4) :
            $(5) :
            $(6) ;
    Depends $(target) : $(common) ;
    CFlags $(target) : [ FDefines SWIG_GLOBAL ] 
	   $(COMPILER.CFLAGS.VISIBILITY_DEFAULT)
	   $(COMPILER.C++FLAGS.EXCEPTIONS.ENABLE) 
	   $(COMPILER.C++FLAGS.STRICTALIASING.DISABLE)
	   $(COMPILER.C++FLAGS.WARNING.NO_UNINITIALIZED) ;

    Depends bindingsclean : $(target)clean ;

    #----------------------------
    # Prepare the C# module.
    #----------------------------
    local cs_extra = [ Wildcard [ ConcatDirs cspacesharp ] : *.cs ] ;
    SEARCH on $(cs_extra) = $(SEARCH_SOURCE) ;
    MakeLocate $(cs_extra:BSG=built) : $(csharpdir) ;
    Clean $(modulecs)clean : $(cs_extra:BSG=built) ;
    local i ;

    for i in $(cs_extra)
    {
      Depends $(i:BSG=built) : $(i) ;
      Copy $(i:BSG=built) : $(i) ;
    }

    Depends csharp_mods : $(cs_extra:BSG=built) ;
  }
}

SubInclude TOP plugins cscript csjava ;
SubInclude TOP plugins cscript csperl5 ;
SubInclude TOP plugins cscript cspython ;
SubInclude TOP plugins cscript pycscegui ;
SubInclude TOP plugins cscript pycore ;
SubInclude TOP plugins cscript pyimesh ;
SubInclude TOP plugins cscript pyisndsys ;
SubInclude TOP plugins cscript pyivaria ;
SubInclude TOP plugins cscript pyiengine ;
SubInclude TOP plugins cscript pycstool ;
SubInclude TOP plugins cscript pyivideo ;
SubInclude TOP plugins cscript pyimap ;
SubInclude TOP plugins cscript pycsgfx ;
SubInclude TOP plugins cscript pycsgeom ;
SubInclude TOP plugins cscript cscsharp ;
SubInclude TOP plugins cscript cshcore ;
SubInclude TOP plugins cscript cshimesh ;
SubInclude TOP plugins cscript cshisndsys ;
SubInclude TOP plugins cscript cshivaria ;
SubInclude TOP plugins cscript cshiengine ;
SubInclude TOP plugins cscript cshcstool ;
SubInclude TOP plugins cscript cshivideo ;
SubInclude TOP plugins cscript cshimap ;
SubInclude TOP plugins cscript cshcsgfx ;
SubInclude TOP plugins cscript cshcsgeom ;

rule PythModDepends
{
  for d in $(1)
  {
    Depends pythmod : $(1) ;
    Depends pythmodclean : $(1)clean ;
  }
}

Description pythmod : "build all python bindings modules" ;
PythModDepends coremod imeshmod isndsysmod ivariamod ienginemod cstoolmod
  ivideomod imapmod csgfxmod csgeommod ;
Depends bindings : pythmod ;

NotFile csharp_mods ;

rule CSharpModDepends
{
  for d in $(1)
  {
    Depends csharpmod : $(1) ;
    Depends csharp_mods : $(1) ;
    Depends csharpmodclean : $(1)clean ;
  }
}

Description csharpmod : "build all the c# bindings modules" ;
CSharpModDepends coresharp imeshsharp isndsyssharp ivariasharp ienginesharp 
  cstoolsharp ivideosharp imapsharp csgfxsharp csgeomsharp ;
Depends bindings : csharpmod ;

# rule to move __init__.py file to the generated python bindings
# folder.

rule CopyCspaceInitPy
{
  local init_py = __init__.py ;
  local init_py_dir = [ ConcatDirs $(TOP) scripts python frozen cspace ] ;
  SEARCH on $(init_py:G=src) = $(init_py_dir) ;
  
  MakeLocate $(init_py:G=out) : [ ConcatDirs $(LOCATE.OBJECTS) bindings python cspace ] ;
  Copy $(init_py:G=out) : $(init_py:G=src) ;
  Depends $(init_py:G=out) : $(init_py:G=src) ;
  Depends pythmod : $(init_py:G=out) ;
  Depends pythmodclean : $(init_py:G=out) ;
  InstallBindingsData $(init_py:G=src) : $(init_py_dir) : bindings python cspace ;
}

# rule to generate a python .pth file on install.
# this allows to have cspace module in cs install location, but still
# have python find it.

actions CspacePthGen bind PACKAGEPATH
{
  echo $(PACKAGEPATH) > $(<)
}

rule InstallCspacePth
{
  local cspace_pth = cspace.pth ;
  MakeLocate $(cspace_pth) : [ ConcatDirs $(libdir) python$(PYTHON.VERSION) site-packages ] ;
  local destdir = [ ConcatDirs $(appdatadir) bindings python ] ;
  NotFile $(destdir) ;
  PACKAGEPATH on $(cspace_pth) = $(destdir) ;
  CspacePthGen $(cspace_pth) ;
  Depends install_bindings : $(cspace_pth) ;
}

if $(PYTHON.AVAILABLE) = "yes"
{
  CopyCspaceInitPy ;
  InstallCspacePth ;
}

