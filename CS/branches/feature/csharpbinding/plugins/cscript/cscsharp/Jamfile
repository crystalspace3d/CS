SubDir TOP plugins cscript cscsharp ;

if $(CSHARP.AVAILABLE) = "yes"
{
  local csharpbase = [ ConcatDirs $(LOCATE.OBJECTS) bindings csharp ] ;
  local csharpdir = [ ConcatDirs $(csharpbase) cspacesharp ] ;
  MkDir $(csharpdir:G=dir) ;
  CleanDir cspacesharpclean : $(csharpdir) ;

  local cs_extra = [ Wildcard [ ConcatDirs cspacesharp ] : *.cs *.key ] ;
  SEARCH on $(cs_extra) = $(SEARCH_SOURCE) ;
  MakeLocate $(cs_extra:BSG=built) : $(csharpdir) ;
  Depends $(cs_extra:BSG=built) : $(csharpdir:G=dir) ;
  Clean cspacesharpclean : $(cs_extra:BSG=built) ;

  local i ;
  for i in $(cs_extra)
  {
    Depends $(i:BSG=built) : $(i) ;
    Copy $(i:BSG=built) : $(i) ;
  }
	
  local csbuildbase = $(csharpbase) ;
  local csbuildxml = csbuild.xml ;
  local cspacesharpdll = crystalspace-sharp.dll ;
  cspacesharpdll = $(cspacesharpdll:G=csharpmod) ;
  SEARCH on $(csbuildxml) = $(SEARCH_SOURCE) ;
  Depends $(csbuildxml:G=build) : $(csbuildxml) ;
  MakeLocate $(csbuildxml:G=build) : $(csharpbase) ;
  Copy $(csbuildxml:G=build) : $(csbuildxml) ;
  Clean csharpmodclean : $(csbuildxml:G=build) ;
  Depends $(cspacesharpdll) : $(csbuildxml:G=build) $(cs_extra:BSG=built) csharp_mods ;
  MakeLocate $(cspacesharpdll) : $(csharpbase) ;
	
  actions NAnt
  {
    $(CSPACESHARP.NANT_PREPARE)
    "$(CMD.NANT)" -quiet -emacs -D:build.compiler.emacs=true -buildfile:$(>)
  }
	
  NAnt $(cspacesharpdll) : $(csbuildxml:G=build) ;
  Clean cspacesharpclean : $(cspacesharpdll) ;
  Depends csharpmod : $(cspacesharpdll) ;
	
  local cspacesharpdll_final = $(cspacesharpdll:G=cspacesharpfinal) ;
  MakeLocate $(cspacesharpdll_final) : $(LOCATE.TARGETS) ;
  Copy $(cspacesharpdll_final) : $(cspacesharpdll) ;
  Depends $(cspacesharpdll_final) : $(cspacesharpdll) ;
  Depends cspacesharpmod : $(cspacesharpdll_final) ;
  Clean cspacesharpclean : $(cspacesharpdll_final) ;
  Depends csharpmodclean : cspacesharpclean ;
}
