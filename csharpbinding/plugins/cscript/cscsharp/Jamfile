SubDir TOP plugins cscript cscsharp ;

if $(CSHARP.AVAILABLE) = "yes" && $(CMD.PERL5)
{
  local csharpbase = [ ConcatDirs $(LOCATE.OBJECTS) plugins cscript cscsharp ] ;
  local csharpdir = [ ConcatDirs $(csharpbase) cspacesharp ] ;
  MkDir $(csharpdir:G=dir) ;
  CleanDir cspacesharpclean : $(csharpdir) ;

  local cs_extra = [ Wildcard [ ConcatDirs cspacesharp ] : *.cs *.key ] ;
  SEARCH on $(cs_extra) = $(SEARCH_SOURCE) ;
  MakeLocate $(cs_extra:BSG=built) : $(csharpdir) ;
  Depends $(cs_extra:BSG=built) : $(csharpdir:G=dir) ;
  Clean cspacesharpclean : $(cs_extra:BSG=built) ;

  local i ;
  for i in $(cs_extra)
  {
    Depends $(i:BSG=built) : $(i) ;
    Copy $(i:BSG=built) : $(i) ;
  }
	
  local csbuildbase = $(csharpbase) ;
  local csbuildxml = csbuild.xml ;
  local cspacesharpdll = crystalspace-sharp.dll ;

  local cs_globals = CS.cs ;
  MakeLocate $(cs_globals) : $(csharpdir) ;
  Depends $(cs_globals) : csharp_mods ;

  local cs_modules_globals = core.cs imesh.cs isndsys.cs ivaria.cs 
	ienginemod.cs cstool.cs ivideo.cs imap.cs csgfx.cs csgeom.cs ;

  for i in $(cs_modules_globals)
  {
    MakeLocate $(i) : $(csharpdir) ;
  }

  GenCSharpGlobals $(cs_globals) : $(cs_modules_globals) :
	 --namespace CrystalSpace --classname CS -x GetSCFPointer
	 -x SetSCFPointer -m public -b cspace ;

  cspacesharpdll = $(cspacesharpdll:G=csharpmod) ;
  SEARCH on $(csbuildxml) = $(SEARCH_SOURCE) ;
  Depends $(csbuildxml:G=build) : $(csbuildxml) ;
  MakeLocate $(csbuildxml:G=build) : $(csharpbase) ;
  Copy $(csbuildxml:G=build) : $(csbuildxml) ;
  Clean csharpmodclean : $(csbuildxml:G=build) ;
  Depends $(cspacesharpdll) : $(csbuildxml:G=build) $(cs_extra:BSG=built) $(cs_globals) csharp_mods ;
  MakeLocate $(cspacesharpdll) : $(csharpbase) ;
	
  actions NAnt
  {
    $(CSPACESHARP.NANT_PREPARE)
    "$(CMD.NANT)" -quiet -emacs -D:build.compiler.emacs=true -buildfile:$(>)
  }
	
  NAnt $(cspacesharpdll) : $(csbuildxml:G=build) ;
  Clean cspacesharpclean : $(cspacesharpdll) ;

  # Copy the .Net dll into bindings/csharp folder
  local cspacesharpdllfinal = $(cspacesharpdll:G=cscsharpfinal) ;
  MakeLocate $(cspacesharpdllfinal) : [ ConcatDirs $(LOCATE.OBJECTS) bindings csharp ] ;
  Copy $(cspacesharpdllfinal) : $(cspacesharpdll) ;
  Depends $(cspacesharpdllfinal) : $(cspacesharpdll) ;
  Clean cspacesharpclean : $(cspacesharpdllfinal) ;

  Depends csharpmod : $(cspacesharpdllfinal) ;
  Depends csharpmodclean : cspacesharpclean ;

  # Installs pkg-config file
  InstallPkgConfig [ DoSourceGrist crystalspace-sharp.pc ] ;
  # Installs the bindings at the Global Assembly Cache
  InstallGAC $(cspacesharpdllfinal) : crystalspace ;
}

